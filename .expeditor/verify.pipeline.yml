---
expeditor:
  defaults:
    buildkite:
      retry:
        automatic:
          limit: 1
      timeout_in_minutes: 30

steps:

- label: ":windows: chef-powershell-shim"
  commands:
    - .expeditor/test_plan.ps1 -Plan habitat
  expeditor:
    executor:
      docker:
        host_os: windows
        shell: [ "powershell", "-Command" ]

- label: ":windows: dotnet-45-dev-pack-x86"
  commands:
    - .expeditor/test_plan.ps1 -Plan habitat-dotnet-45-dev-pack-x86
  expeditor:
    executor:
      docker:
        host_os: windows
        shell: [ "powershell", "-Command" ]

- label: ":windows: dotnet-5-sdk-x86"
  commands:
    - .expeditor/test_plan.ps1 -Plan habitat-dotnet-5-sdk-x86
  expeditor:
    executor:
      docker:
        host_os: windows
        shell: [ "powershell", "-Command" ]

- label: ":windows: vs-2019-x86"
  commands:
    - .expeditor/test_plan.ps1 -Plan habitat-vs-2019-x86
  expeditor:
    executor:
      docker:
        host_os: windows
        shell: [ "powershell", "-Command" ]

- label: ":windows: win-10-sdk-x86"
  commands:
    - .expeditor/test_plan.ps1 -Plan habitat-win-10-sdk-x86
  expeditor:
    executor:
      docker:
        host_os: windows
        shell: [ "powershell", "-Command" ]

- label: ":windows: chef-powershell-shim-x86"
  commands:
    - .expeditor/test_plan.ps1 -Plan habitat-x86
  expeditor:
    executor:
      docker:
        host_os: windows
        shell: [ "powershell", "-Command" ]

- label: ":windows: build-and-publish-windows-gem"
  command:
    - cd chef-powershell
    - gem install bundler:2.2.29
    - C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command "[System.Net.ServicePointManager]::SecurityProtocol = 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))" && SET "PATH=%PATH%;%ALLUSERSPROFILE%\chocolatey\bin"
    - choco install nodejs -y
    - SET "PATH=%PATH%;C:\Program Files\nodejs\"
    - refreshenv
    - npm install -g cspell
    - bundle update
    - bundle config --local path vendor/bundle
    - bundle install --jobs=7 --retry=3
    - bundle exec rake all
  expeditor:
    executor:
      docker:
        host_os: windows
        user: 'NT AUTHORITY\SYSTEM'